ARG SERVER_IMAGE=origam-server-linux
FROM ${SERVER_IMAGE}

# Ensure we run privileged steps as root
USER root
SHELL ["/bin/bash", "-c"]

# INSTALL dotnet SDK (because we will run dotnet test later on)
RUN apt-get -qq update \
 && apt-get -qq install -y wget gpg apt-transport-https sudo \
 && wget https://packages.microsoft.com/config/debian/12/packages-microsoft-prod.deb -O /tmp/packages-microsoft-prod.deb \
 && dpkg -i /tmp/packages-microsoft-prod.deb \
 && rm /tmp/packages-microsoft-prod.deb \
 && apt-get -qq update \
 && apt-get -qq install -y dotnet-sdk-8.0 

# Install Chrome (modern keyring flow; no apt-key)
RUN set -eux; \
    apt-get -qq update; \
    DEBIAN_FRONTEND=noninteractive apt-get -qq install -y --no-install-recommends \
      ca-certificates curl gnupg xvfb \
      fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf \
      libxss1; \
    install -d -m 0755 /etc/apt/keyrings; \
    curl -fsSL https://dl.google.com/linux/linux_signing_key.pub \
      | gpg --dearmor -o /etc/apt/keyrings/google-linux-signing-keyring.gpg; \
    echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-linux-signing-keyring.gpg] https://dl.google.com/linux/chrome/deb/ stable main" \
      > /etc/apt/sources.list.d/google-chrome.list; \
    apt-get -qq update; \
    DEBIAN_FRONTEND=noninteractive apt-get -qq install -y --no-install-recommends google-chrome-stable; \
    rm -rf /var/lib/apt/lists/*

RUN apt-get -qq update && apt-get -qq install -y --no-install-recommends gawk && rm -rf /var/lib/apt/lists/*


# Copy test files
USER origam
WORKDIR /home/origam
RUN mkdir -p HTML5/data/origam HTML5_TESTS output

COPY --chown=origam:origam entrypoint.sh \
    /home/origam/HTML5/

COPY --chown=origam:origam HTML5_TESTS \
    _OrigamSettings.wf.mssql.template \
    _OrigamSettings.wf.pgsql.template \
    log4net.config \
    /home/origam/HTML5_TESTS/

COPY --chown=origam:origam tests_e2e /home/origam/HTML5/tests_e2e/
COPY --chown=origam:origam model /home/origam/projectData/model/

WORKDIR /home/origam/HTML5
RUN chmod +x entrypoint.sh

# The source server image starts the entrypoint.sh, no need to change it here
#ENTRYPOINT ["/bin/bash"]
