DROP PROCEDURE IF EXISTS "OrigamIdentityGrantCleanup";

create procedure "OrigamIdentityGrantCleanup"()
  language plpgsql
as
$$
DECLARE
    current_datetime TIMESTAMP := (now() AT TIME ZONE 'UTC');
BEGIN
    LOOP
        WITH rows AS (
            SELECT ctid FROM "OrigamIdentityGrant"
            WHERE "Expiration" < current_datetime
            LIMIT 1000
        )
        DELETE FROM "OrigamIdentityGrant"
        WHERE ctid IN (SELECT ctid FROM rows);

        -- Exit if no rows were affected
        EXIT WHEN NOT FOUND;
    END LOOP;
END;
$$;

alter procedure "OrigamIdentityGrantCleanup"() owner to origam;
